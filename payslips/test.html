<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
dl { width: 20em; }
dt { float: left; margin-right: 2em; }
dd { text-align: right; }
.output { font-size: 1em; font-family: monospace; box-sizing: border-box; border: 5px solid; width: 100%; height: 45%; margin-bottom: 1em; }
@media (min-width: 800px) { .output, .output-head { float: right; width: 50%; margin-right: 2%; }}
.code { white-space: pre; }
.pass { border-color: green; }
.fail { border-color: red; }
.added { color: green; }
.removed { color: red; }
.hidden { display: none; }
</style>
<span class="output-head">Output:</span>
<textarea class="output fail" rows="20" cols="100" id="test-output"></textarea>
<span class="output-head diff">Diff:</span>
<div class="output code diff" id="diff"></div>
<table class="ignore-this-table">
<tr><td></td></tr>
</table>

<div class="buttons">
    <a class="btn download-payslips-modal-btn">Download PDF</a>
</div>

<div class="modal-content">
    <div class="date">
        <div><table class="listings"><thead>
            <tr><th></th><th>Process date</th></tr>
        </thead><tbody>
            <tr><td></td><td>24/06/2022</td></tr>
        </tbody></table></div>
    </div>

    <table class="listings">
        <thead><tr>
            <th>Payments</th>
            <th>Units</th>
            <th>Rate</th>
            <th>Amount</th>
        </tr></thead>
        <tbody><tr>
            <td>Salary1</td>
            <td>1</td>
            <td>1,234.56</td>
            <td>1,234.56</td>
        </tr></tbody>
    </table>

    <table class="listings">
        <thead><tr>
            <th>Deductions</th>
            <th>Amount</th>
        </tr></thead>
        <tbody><tr>
            <td>PAYE tax</td>
            <td>876.54</td>
        </tr><tr>
            <td>National Insurance</td>
            <td>234.56</td>
        </tr><tr>
            <td>Total</td>
            <td>1,111.11</td>
        </tr></tbody>
    </table>
</div>

<script type="text/plain" id="expected-output">
!Account
NPayslips
TBank
^
!Type:Bank
D2022-06-24
T1234.56
MSalary1
LSalary:Gross Pay
PAnswer Digital
^
D2022-06-24
T-876.54
MPAYE tax
LTaxes:Income Tax
P
^
D2022-06-24
T-234.56
MNational Insurance
LInsurance:NI
P
^
</script>
<script src="tampermonkey.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.0.0/diff.js"></script>
<script>
// taken from https://github.com/smallhelm/diff-lines
function diff(a, b) {

    var diffs = Diff.diffLines(a, b, {ignoreWhitespace: false});
    var out = [];
    var lines_with_change = [];

    diffs.forEach(function (d) {
        var mod = d.removed && d.added ? '!' : (d.removed ? '-' : (d.added ? '+' : ' '));
        var type = '';
        switch (mod) {
            case '+':
                type = 'added';
                break;
            case '-':
                type = 'removed';
                break;
        }
        var lines = d.value.split('\n');
        if (lines.length > 0 && lines[lines.length - 1] === '') {
            lines = lines.slice(0, lines.length - 1);
        }
        lines.forEach(function (line) {
            if (mod !== ' ') {
                lines_with_change.push(out.length);
            }
            out.push('<span class="' + type + '">' + mod + line + '</span>');
        });
    });

    var short_out = {};
    lines_with_change.forEach(function (line_i) {
        for (var i = -3; i < 4; i++) {
            var j = line_i + i;
            if (j >= 0 && j < out.length) {
                short_out[j] = out[j];
            }
        }
    });

    out = [];
    var last_key;
    var key;
    for (key in short_out) {
        if (short_out.hasOwnProperty(key)) {
            if (last_key !== undefined && parseInt(key) !== (parseInt(last_key) + 1)) {
                out.push('@@');
            }
            out.push(short_out[key]);
            last_key = key;
        }
    }

    return out.join('\n');
}

// fake the payslip retrieval
let mock = new XMLHttpRequest();
mock.open('GET', 'test.html?fake=directory/123/payslips');
mock.send();

setTimeout(() => {
    // fake the download button click
    let download = document.querySelector('.buttons .btn');
    download.click();

    let testOutput = document.getElementById('test-output'),
        expected = document.getElementById('expected-output').innerText.trim(),
        actual = testOutput.value.trim();

    if (expected == actual) {
        testOutput.classList.replace('fail', 'pass');
        document.querySelectorAll('.diff').forEach(e => e.classList.add('hidden'));
    }
    else {
        document.getElementById('diff').innerHTML = diff(expected, actual);
    }
}, 250);
</script>

<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
dl { width: 20em; }
dt { float: left; margin-right: 2em; }
dd { text-align: right; }
.output { font-size: 1em; font-family: monospace; box-sizing: border-box; border: 5px solid; width: 100%; height: 45%; margin-bottom: 1em; }
@media (min-width: 800px) { .output, .output-head { float: right; width: 50%; margin-right: 2%; }}
.code { white-space: pre; }
.pass { border-color: green; }
.fail { border-color: red; }
.added { color: green; }
.removed { color: red; }
.hidden { display: none; }
</style>
<span class="output-head">Output:</span>
<textarea class="output fail" rows="20" cols="100" id="test-output"></textarea>
<span class="output-head diff">Diff:</span>
<div class="output code diff" id="diff"></div>
<table class="ignore-this-table">
<tr><td></td></tr>
</table>

<div class="date">
    <div><table><thead>
        <tr data-automation-id="tableHeaderRow"><th></th><th>
            <span>Payment Date</span>
            <span>Other text</span>
        </th></tr>
    </thead><tbody>
        <tr><td></td><td>
            <span>27-June-2013</span>
        </td></tr>
    </tbody></table></div>
</div>

<div data-automation-id="fieldSetBody">
    <div data-automation-id="rivaWidget">
        <div data-automation-id="gridToolbar"><span class="gwt-InlineLabel">Earnings</span></div>
        <table><thead><tr>
            <th>Description</th>
            <th>Dates</th>
            <th>Hours</th>
            <th>Rate</th>
            <th>Amount</th>
            <th>YTD</th>
        </tr></thead>
        <tbody class="grid-body-row"><tr tabindex="0">
            <td>
                Monthly Salary
            </td>
            <td></td>
            <td></td>
            <td></td>
            <td>1,234.56</td>
            <td></td>
        </tr><tr tabindex="0">
            <td>Call Out</td>
            <td></td>
            <td></td>
            <td></td>
            <td>123.45</td>
            <td></td>
        </tr><tr tabindex="0">
            <td>Company Performance Bonus</td>
            <td></td>
            <td></td>
            <td></td>
            <td>5,432.10</td>
            <td></td>
        </tr><tr tabindex="0">
            <td>Thank You Bonus</td>
            <td></td>
            <td></td>
            <td></td>
            <td>5,999.10</td>
            <td></td>
        </tr><tr tabindex="0">
            <td>Refer a Friend Bonus</td>
            <td></td>
            <td></td>
            <td></td>
            <td>1,000.00</td>
            <td></td>
        </tr><tr tabindex="0">
            <td>Shares</td>
            <td></td>
            <td></td>
            <td></td>
            <td>8,000.00</td>
            <td></td>
        </tr><tr tabindex="0">
            <td>Overtime x 1.5</td>
            <td></td>
            <td>10</td>
            <td></td>
            <td>234.56</td>
            <td></td>
        </tr><tr tabindex="0">
            <td>TABLET'S</td>
            <td></td>
            <td></td>
            <td></td>
            <td>(116.50)</td>
            <td></td>
        </tr><tr tabindex="0">
            <td>EE Smart Pension</td>
            <td></td>
            <td></td>
            <td></td>
            <td>(98.76)</td>
            <td></td>
        </tr><tr tabindex="0">
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td>Total: 9,999.99</td>
            <td></td>
        </tr></tbody>
    </table></div>
    <div data-automation-id="rivaWidget">
        <div data-automation-id="gridToolbar"><span class="gwt-InlineLabel">Statutory Deductions</span></div>
        <table><thead><tr>
            <th>Description</th>
            <th>NI Category</th>
            <th>Dates</th>
            <th>Amount</th>
            <th>YTD</th>
        </tr></thead>
        <tbody class="grid-body-row"><tr tabindex="0">
            <td>Employee NI</td>
            <td></td>
            <td></td>
            <td>333.33</td>
            <td></td>
            <td></td>
        </tr><tr tabindex="0">
            <td>Income Tax</td>
            <td></td>
            <td></td>
            <td>567.89</td>
            <td></td>
            <td></td>
        </tr><tr tabindex="0">
            <td></td>
            <td></td>
            <td></td>
            <td>Total: 1,111.11</td>
            <td></td>
            <td></td>
        </tr></tbody>
    </table></div>
    <div data-automation-id="rivaWidget">
        <div data-automation-id="gridToolbar"><span class="gwt-InlineLabel">Deductions</span></div>
        <table><thead><tr>
            <th>Description</th>
            <th>Amount</th>
            <th>YTD</th>
        </tr></thead>
        <tbody class="grid-body-row"><tr tabindex="0">
            <td>Pennies From Heaven</td>
            <td>0.01</td>
            <td></td>
            <td></td>
        </tr><tr tabindex="0">
            <td>Miscellaneous Deduction (Net)</td>
            <td>4,123.45</td>
            <td></td>
            <td></td>
        </tr></tbody>
    </table></div>
    <div data-automation-id="rivaWidget">
        <div data-automation-id="gridToolbar"><span class="gwt-InlineLabel">Employer Costs</span></div>
        <table><thead><tr>
            <th>Description</th>
            <th>Amount</th>
            <th>YTD</th>
        </tr></thead>
        <tbody class="grid-body-row"><tr tabindex="0">
            <td>ER Smart Pension</td>
            <td>151.51</td>
            <td></td>
            <td></td>
        </tr><tr>
            <td>Employers NI</td>
            <td>999.99</td>
            <td></td>
            <td></td>
        </tr></tbody>
    </table></div>
</div>

<script type="text/plain" id="expected-output">
!Account
NPayslips
TBank
^
!Type:Bank
D2013-06-27
T1234.56
MMonthly Salary
LSalary:Gross Pay
PSky Bet
^
D2013-06-27
T123.45
MCall Out
LSalary:Gross Pay
PSky Bet
^
D2013-06-27
T5432.10
MCompany Performance Bonus
LSalary:Bonus
PSky Bet
^
D2013-06-27
T5999.10
MThank You Bonus
LSalary:Bonus
PSky Bet
^
D2013-06-27
T1000.00
MRefer a Friend Bonus
LSalary:Bonus
PSky Bet
^
D2013-06-27
T8000.00
MShares
L[Shares]
PSky Bet
^
D2013-06-27
T234.56
MOvertime x 1.5: 10
LSalary:Overtime
PSky Bet
^
D2013-06-27
T-116.50
MTABLETS
LComputing:Hardware
P
^
D2013-06-27
T-98.76
MEE Smart Pension
L[Pension]
P
^
D2013-06-27
T-333.33
MEmployee NI
LInsurance:NI
P
^
D2013-06-27
T-567.89
MIncome Tax
LTaxes:Income Tax
P
^
D2013-06-27
T-0.01
MPennies From Heaven
LDonations
PPennies From Heaven
^
D2013-06-27
T-4123.45
MMiscellaneous Deduction (Net)
LSalary:Bonus
PSky Bet
^
!Account
NPension
TBank
^
!Type:Bank
D2013-06-27
T151.51
MER Smart Pension
LRetirement:Pension
PSky Bet
^
</script>
<script src="payslips.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.0.0/diff.js"></script>
<script>
// taken from https://github.com/smallhelm/diff-lines
function diff(a, b) {

    var diffs = Diff.diffLines(a, b, {ignoreWhitespace: false});
    var out = [];
    var lines_with_change = [];

    diffs.forEach(function (d) {
        var mod = d.removed && d.added ? '!' : (d.removed ? '-' : (d.added ? '+' : ' '));
        var type = '';
        switch (mod) {
            case '+':
                type = 'added';
                break;
            case '-':
                type = 'removed';
                break;
        }
        var lines = d.value.split('\n');
        if (lines.length > 0 && lines[lines.length - 1] === '') {
            lines = lines.slice(0, lines.length - 1);
        }
        lines.forEach(function (line) {
            if (mod !== ' ') {
                lines_with_change.push(out.length);
            }
            out.push('<span class="' + type + '">' + mod + line + '</span>');
        });
    });

    var short_out = {};
    lines_with_change.forEach(function (line_i) {
        for (var i = -3; i < 4; i++) {
            var j = line_i + i;
            if (j >= 0 && j < out.length) {
                short_out[j] = out[j];
            }
        }
    });

    out = [];
    var last_key;
    var key;
    for (key in short_out) {
        if (short_out.hasOwnProperty(key)) {
            if (last_key !== undefined && parseInt(key) !== (parseInt(last_key) + 1)) {
                out.push('@@');
            }
            out.push(short_out[key]);
            last_key = key;
        }
    }

    return out.join('\n');
}

var testOutput = document.getElementById('test-output'),
    expected = document.getElementById('expected-output').innerText.trim(),
    actual = testOutput.value.trim();

if (expected == actual) {
    testOutput.classList.replace('fail', 'pass');
    document.querySelectorAll('.diff').forEach(e => e.classList.add('hidden'));
}
else {
    document.getElementById('diff').innerHTML = diff(expected, actual);
}
</script>
